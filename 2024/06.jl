### A Pluto.jl notebook ###
# v0.20.3

using Markdown
using InteractiveUtils

# ╔═╡ d955534c-52b4-11ec-10b7-bf7961e70d1d
md"### Advent of Code 2024 - Day 06"

# ╔═╡ 6a1dab04-f860-4a26-8c59-3f0298bf4ddb
md"# Part A - Guard Gallivant"

# ╔═╡ b5026ac5-7609-4c9e-8210-8beb8fa63dd4
# Monkey patch for a denser matrix function
function Base.show(io::IO, ::MIME"text/plain", m::Matrix{Char})
    for i in 1:size(m, 1)
        for j in 1:size(m, 2)
            print(io, m[i,j])
        end
        println(io)
    end
end

# ╔═╡ 9bdbf2da-9b3b-46c8-a6c9-20c965541b3c
function partA(d)
	g=d |> IOBuffer |> readlines 
	g=stack(g,dims=1)
	(m,n)=size(g)

	p=findall( x -> x=='^', g)[1].I |> collect |> vec 
	# slight madnesses unpacking the 'CartesianIndex' returned by findall

	g[p[1],p[2]]='X' # set starting position as occupied; MF off by one error in PartA
	
	delta=vec([-1,0])

	turnright=[0 1; -1 0] # cooking with gas baby

	while true
		p+=delta  

		if p[1]<1 || p[2]<1 || p[1]>m || p[2]>n # walked off grid
			break
		end
		
#		println("posn: $(p) delta: $(delta)")
		if g[p[1],p[2]]=='#'
			p-=delta # undo our step
			delta=turnright*delta # turn right

			#return delta, g, p 
			continue # step on
		end

		g[p[1],p[2]]='X' # step was ok
	end
	return g, count(isequal('X'), g)
end

# ╔═╡ 303c43ab-e1c4-4920-99b6-e2587e9e54c0
md"# Part B - Infinite Loop"

# ╔═╡ 17d88df9-37f3-451d-aa3b-9e9233be5dbe
function looper(g,p,m,n)
	delta=vec([-1,0])

	turnright=[0 1; -1 0] # cooking with gas baby

	steps=0
	while true
		steps+=1
		p+=delta  
		
		if p[1]<1 || p[2]<1 || p[1]>m || p[2]>n # walked off grid
			break
		end
		
#		println("posn: $(p) delta: $(delta)")
		if g[p[1],p[2]]=='#'
			p-=delta # undo our step
			delta=turnright*delta # turn right

			#return delta, g, p 
			continue # step on
		end

		g[p[1],p[2]]='X' # step was ok

		if steps>20000 # yeah, that's ≈∞
			return true
		end
	end
#	println(count(isequal('X'), g))
	return false 
end

# ╔═╡ 17b76137-1638-4f44-a9e6-93120f907ff2
function partB(d)
	g=d |> IOBuffer |> readlines 
	g=stack(g,dims=1)
	(m,n)=size(g)

	p=findall( x -> x=='^', g)[1].I |> collect |> vec 
	# slight madnesses unpacking the 'CartesianIndex' returned by findall

	g[p[1],p[2]]='X' # set starting position as occupied; MF off by one error in PartA

	loops=0
	for blocks in findall(x->x=='.', g)
#		println("Blocks: $blocks")
		gb=deepcopy(g)
		gb[blocks]='#' 
		if looper(gb,p,m,n)
			loops+=1
		end
	end
	
	return loops
end

# ╔═╡ adfc7059-e20b-433d-8507-fc0f9a802d10
md"""
## Postmortem notes

This was fun! 

PartA I got it working for the test input, then had the off-by one error because I did not mark the starting position of the guard. So I got as far as writing the 'show' interface to display the grid and think about trying to watch the trace and try and debug it etc. , before realising that I had forgot this constraint. 

I felt really dirty just putting a watchdog timer on the halting problem (partB) and deciding that 10000 ~= infinity. 
I suppose formally, the guard couldn't have taken more steps than double the number of grid spaces without infinite looping (double as you can cross your path), so it's not so crazy a limit. 

I did think of actually detecting the loop, by leaving breadcrumbs in the lattice of which direction the guard was going in as they crossed a square, so if you found yourself in the same place and you were NOT crossing your path, you had infinite looped. 

But if works it works!
"""

# ╔═╡ 91996ec5-55ce-4b2c-a4df-4e5b0b89f5f0
test="""
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

# ╔═╡ baa6eaa1-f0ee-44e5-8ac0-8507162c9d9b
partA(test)[2]==41

# ╔═╡ 08273f85-3f20-4b01-b39e-c1d7846a9334
a=partA(test)

# ╔═╡ c36f4493-a5ad-4eef-8837-b8adbfd10d2a
partB(test)

# ╔═╡ dd3d11c4-a3fb-436a-82ff-71ab133f9c30
partB(test)==6

# ╔═╡ 926042ad-215f-4585-8fa3-b0bcdf5f427e
input="""
.....#..#................#...#.....#.......................................................#.............................##.......
......................#..............................................................#..............#..........................#..
.........#........................#.....................................................#..............#...........#........##....
..........#......................#.....#...#............#..........................#.....#........................................
#....................................................................................................................#............
.#....#......................#.......................#...............................#...#.....#...................#........#.....
..#..#.......................##........#...............................................................#........#.........#.......
..............................................................#...#.........#..#..................................................
.............####..................................#................#..#.....................................#.....#..............
..........#................#................................................#........................#.....#......................
..............................................#.........#.....................#..................#.......................#........
.........................................##..#.................................#.....#............................................
............#..#...#...............................#.#.....#...............#...............................#..............#.#.#..#
.................#..........#..#....#.....................#......................................##............#..................
.......#....#.....................#......##...................#..............#.................#........#..#......#...............
...............................................#.............#....................................................................
..............#..............................................##..................#..........................#............#........
................#.......................#..#............................................................#..........#..#.........#.
.#.......................###............#.........#.................................................#.............................
........#......................................................................................#.....#.......#...#................
#.#.........................#..#.............................................#....#........................#......................
.......#.....#...............................#.....#......................#.................................#.....#...#...........
................................................................................................#............#....................
.......#......#...............#...#............................#................................#................................#
.#.....................................................................................................................#......#...
...........#..........................................#........#...................#..............................................
....#......................................................................................#.....##.#...................#.........
...#..........................................................................##.......................................#.....#....
#........#................#...............#.........#..#.#..............##..............#........#............#....#.....#........
......#......................................#...............#....#..#...........................#................................
#..............................................................................#............#...#..#....................#......#..
.......#.........................................#.........#.......#....................................#.........................
......#......#.............................................#.....................#...........#.............#..#...................
#.......................#........#............................................##..............................#...................
..........................................................................#........................................#....#......#..
..........#..#...............................................#............................#.#..............................#......
....#...........#..#...................................#................................................................#.........
..............#..........#...............#....#.....................................#.......................#.....................
.............#........#....#.........#...............#.........#..................................................................
.#......#...................#.......#...........................................................................#.............#...
.............##...........#.........................................#......................#.......................#..............
.....#................#.....#...................##.......#......#...........#.......#............................................#
.#..#.............................................................#..............................................#................
...#......#............................#..........................................................................................
...................................................................................#..............................................
#...................................#...................##..................#...............................................#.....
................#.....#...........................#...............................................................................
.................................#............#........................................................#.............#............
..................#......#........................................................#..^.....#......................................
..#.....#.................................................#........#.........................................................#..#.
................#..............................#....................................................#.............................
................#....#..........................................#............................#....................................
...............#.......................................#.....................................#..............................#.....
..................................................#............#..............#........##.#.....................................#.
.#..................................#......#..#............#.................#.............#......#..#.......................#....
..................#..............................#..........................#..........................##............#.......#....
.........#..................................................................#...................#..........................#......
................#....................................#............#............................................................#..
..##..........#.#..#........................#....#.................................#.............................................#
............................................#.........................................................#..#...................#...#
.......................................#......................................................................#...................
....#.......................#...#.........................................................................#................#......
...........#...........#............#.....#...#...................#........................................#.................##...
....#...........................................................................................#.................................
..............................................................................#.#.............................................#...
.........#..#..............................................#......................................................................
#...................#........#............#.......#.....................#................#.#.#............#..................#....
.......................#................#.....#...........#.....................#...........................#..........#.........#
........................................................................#.#.....................#.................................
...#.................................................#..........................#........#.......................#................
............................#...........#.......#.................................#.##...........#............................#...
...##.....................................#.........................#...........#...................................#.............
#.#..#................................#.........#..#.#..........#......................#............#......................#......
....#.............................................................#...............................................................
...............#.#......#........................................................................#.........................#......
................#.....#...#...............#.........................................#....#...........................#.......#....
...............#.........................................................................#........................................
..........................#..##...................................................................................................
.##....................#..#.....................#..............................................#........................#.........
............................................................................................#............#........................
#...................#...#......................#...............#............#....................................#................
...........................#........#......................................................................#......................
................................#...#...#.#.......#.................#.......#................##...................................
........................#.......................#.................................................................................
#...#...............#.........................................................................#.......................#...........
.........#...................#...............................................#...................##..............................#
.....#............................................................................................................................
.#.......#...............................................................#.......................#................#..........#....
....................................#..........#......#...........................................................#.#.#..#...#....
......................#..............................................##..................#........................................
....#......#...................#................#..............................................................................#..
...........#.................##.#...................................................#..#................#.........................
......#.....#......#...#........#.....................................#....#...........#................#..........#..............
#.......##.....#........#...........................................#...#..........#.............#........#.......#...............
......................#......#...................#.........................#........................#..................#...#......
.....#...........#...#.........................##.......#.....................................#...................................
....................................................................#.............................................................
........#...............#.........................................................................................................
.......................#.........................#..........................................#.#....#..#....#......................
........................##............................................................#.....#.........#....#......#..#............
........................#........#..................#................#.#.##............#..........................................
.......................................................#.........................#...............##...................##....#...#.
........#...#.............#...........#........#......................#...#.........#..#..................#.#............#........
#.#....................#..........................................#...................................................#........#..
...............................................#............#.....#.#...........#........#.#....................................#.
......#..........................................#............................................................#..........#...#...#
....................#......................................#....#..............................#....................#.............
......................#.#.....#......#....#..#....................................................................................
.....#..........................................#.........#...................................#................#.......#..........
........##....................................................................#...................................#.............#.
#.........................................#..#....#................#.#.....#....................#............................#....
#....#..#..........#..................#......................#....................................................................
...................#..#....#...................#...........................#.#..#............#......#................#.......#.#..
...............#......................................................#......#..#..............#.....................#............
............#.....................#.........#....#...............#.......#...#...............#.......................##.#.........
....#............#..................#....#.......................#..............................................#...#.............
..........................................#....#..........#..#....................#......#......................#...#.............
............#..........#...........#......#..#......................................................................#.............
...#.................#.............................................................#..............................................
.....#.#.........#....................................................#..................#...............#........................
..#......................##.....#.........#..............#..#............#..#............................................#........
...................#.....#.........#........#....................#..................................#................#............
....#.............................#.............................#.......................#.......................#.....#...........
...#......#....#...........#............................#.....#........#......#...................................................
........#..........#............................#..#..#.......................................#....#.##...........................
.......#......##........#.................#.............................................................#....#........#...........
.....................#............................................#.#......#.....##....#........#.................................
...........#.....................##.#....#..#.....................................................................................
....................#......#................................#.....................................................#.......#..#....
.....................................................#.........#.......................................#.....##..#................"""

# ╔═╡ edf61e55-3e0d-45af-b535-bb5cbcd31bc2
g,c=partA(input)

# ╔═╡ 89cc0221-a606-45fd-96b1-6b9d240b7c7f
partB(input)

# ╔═╡ Cell order:
# ╟─d955534c-52b4-11ec-10b7-bf7961e70d1d
# ╟─6a1dab04-f860-4a26-8c59-3f0298bf4ddb
# ╠═baa6eaa1-f0ee-44e5-8ac0-8507162c9d9b
# ╠═08273f85-3f20-4b01-b39e-c1d7846a9334
# ╠═edf61e55-3e0d-45af-b535-bb5cbcd31bc2
# ╠═b5026ac5-7609-4c9e-8210-8beb8fa63dd4
# ╠═9bdbf2da-9b3b-46c8-a6c9-20c965541b3c
# ╟─303c43ab-e1c4-4920-99b6-e2587e9e54c0
# ╠═c36f4493-a5ad-4eef-8837-b8adbfd10d2a
# ╠═dd3d11c4-a3fb-436a-82ff-71ab133f9c30
# ╠═89cc0221-a606-45fd-96b1-6b9d240b7c7f
# ╠═17b76137-1638-4f44-a9e6-93120f907ff2
# ╠═17d88df9-37f3-451d-aa3b-9e9233be5dbe
# ╟─adfc7059-e20b-433d-8507-fc0f9a802d10
# ╠═91996ec5-55ce-4b2c-a4df-4e5b0b89f5f0
# ╠═926042ad-215f-4585-8fa3-b0bcdf5f427e
